#!/bin/bash

#==============================================================================#
#                                                                              #
#                 Philosophers - Strict Functions Test                         #
#                                                     by: Allan Rabelo (2025)  #
#==============================================================================#

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# STRICTLY ALLOWED FUNCTIONS - ONLY THESE ARE PERMITTED
STRICTLY_ALLOWED=(
	"memset" "printf" "malloc" "free" "write"
	"usleep" "gettimeofday" "pthread_create"
	"pthread_detach" "pthread_join" "pthread_mutex_init"
	"pthread_mutex_destroy" "pthread_mutex_lock"
	"pthread_mutex_unlock"
)

display_header() {
	echo -e "${BLUE}"
	echo "================================================"
	echo "           STRICT FUNCTIONS TEST"
	echo "    Any function not in allowed list = FAIL"
	echo "================================================"
	echo -e "${NC}"
}

find_philo_directory() {
	local paths=(
	"../philosophers"
	"../../philosophers"
	"../philo"
	"../../philo"
	"./philosophers"
	".")
	
	for path in "${paths[@]}"; do
		if [ -d "$path" ] && [ -f "$path/Makefile" ]; then
			echo "$path"
			return 0
		fi
	done
	
	local found_dir
	found_dir=$(find . -maxdepth 2 -name "Makefile" -type f | head -1 | xargs dirname 2>/dev/null)
	
	if [ -n "$found_dir" ] && [ -d "$found_dir" ]; then
		echo "$found_dir"
		return 0
	fi
	
	return 1
}

compile_project() {
	local dir="$1"
	
	cd "$dir" || return 1
	make clean > /dev/null 2>&1
	if ! make > /dev/null 2>&1; then
		cd - > /dev/null
		return 1
	fi
	cd - > /dev/null
	return 0
}

get_used_functions() {
	local binary="$1"
	nm -u "$binary" 2>/dev/null | awk '{print $2}' | sed 's/@.*//' | sort -u
}

check_functions() {
	local used_functions="$1"
	local -n forbidden_ref="$2"
	
	for func in $used_functions; do
		local allowed=0
		
		for allowed_func in "${STRICTLY_ALLOWED[@]}"; do
			if [ "$func" = "$allowed_func" ]; then
				allowed=1
				break
			fi
		done
		
		if [ $allowed -eq 0 ] && [[ $func =~ ^[a-zA-Z_][a-zA-Z0-9_]*$ ]] && [[ ! $func =~ ^_ ]]; then
			forbidden_ref+=("$func")
		fi
	done
}

display_allowed_list() {
	echo -e "${YELLOW}=== STRICTLY ALLOWED FUNCTIONS ===${NC}"
	local count=0
	for func in "${STRICTLY_ALLOWED[@]}"; do
		printf "%-25s" "$func"
		((count++))
		if [ $((count % 3)) -eq 0 ]; then
			echo
		fi
	done
	echo
}

main() {
	display_header
	
	# Find project
	PHILO_DIR=$(find_philo_directory)
	if [ -z "$PHILO_DIR" ]; then
		echo -e "${RED}Error: philosophers directory not found${NC}"
		exit 1
	fi
	
	echo -e "${GREEN}✓ Project found: $PHILO_DIR${NC}"
	
	# Compile
	if ! compile_project "$PHILO_DIR"; then
		echo -e "${RED}Error: Compilation failed${NC}"
		exit 1
	fi
	
	echo -e "${GREEN}✓ Project compiled successfully${NC}"
	
	PHILO_EXEC="$PHILO_DIR/philo"
	if [ ! -f "$PHILO_EXEC" ]; then
		echo -e "${RED}Error: philo executable not found${NC}"
		exit 1
	fi
	
	# Get used functions
	USED_FUNCTIONS=$(get_used_functions "$PHILO_EXEC")
	if [ -z "$USED_FUNCTIONS" ]; then
		echo -e "${RED}Error: Could not read binary functions${NC}"
		exit 1
	fi
	
	echo
	echo -e "${YELLOW}=== DETECTED FUNCTIONS ===${NC}"
	
	# Check each function
	local forbidden_functions=()
	local all_allowed=true
	
	for func in $USED_FUNCTIONS; do
		local is_allowed=0
		
		for allowed_func in "${STRICTLY_ALLOWED[@]}"; do
			if [ "$func" = "$allowed_func" ]; then
				echo -e "${GREEN}✓ ALLOWED: $func${NC}"
				is_allowed=1
				break
			fi
		done
		
		if [ $is_allowed -eq 0 ] && [[ $func =~ ^[a-zA-Z_][a-zA-Z0-9_]*$ ]] && [[ ! $func =~ ^_ ]]; then
			echo -e "${RED}✗ FORBIDDEN: $func${NC}"
			forbidden_functions+=("$func")
			all_allowed=false
		fi
	done
	
	display_allowed_list
	
	# Final verdict
	echo
	echo -e "${BLUE}=== TEST RESULT ===${NC}"
	
	if $all_allowed; then
		echo -e "${GREEN}✅ SUCCESS: All functions are permitted!${NC}"
		echo -e "${GREEN}Your project complies with the strict function rules.${NC}"
		exit 0
	else
		echo -e "${RED}❌ FAILURE: Forbidden functions detected!${NC}"
		echo -e "${RED}The following functions are NOT allowed:${NC}"
		for func in "${forbidden_functions[@]}"; do
			echo -e "  ${RED}• $func${NC}"
		done
		echo
		echo -e "${YELLOW}Remove these functions from your code.${NC}"
		exit 1
	fi
}

main